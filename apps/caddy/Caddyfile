{
    admin off
    auto_https off
    servers {
        trusted_proxies static private_ranges
    }
}

:{$PORT} {
    encode zstd gzip

    header {
        X-Content-Type-Options nosniff
        Referrer-Policy strict-origin-when-cross-origin
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
    }

    @backend path /auth /auth/* /rpc /rpc/*
    handle @backend {
        reverse_proxy http://{$SERVER_DOMAIN}:{$SERVER_PORT}
    }
    handle {
        header {
            X-Frame-Options DENY
            Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'"
            Permissions-Policy "geolocation=(), camera=(), microphone=()"
        }
        reverse_proxy http://{$WEB_DOMAIN}:{$WEB_PORT}
    }
}
